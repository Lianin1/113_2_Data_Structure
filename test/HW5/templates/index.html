<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>ä¸»ç®¡èˆ‡å“¡å·¥ 1:1 å°è©±åˆ†æç³»çµ±</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        #upload-form { margin-bottom: 20px; }
        #progress, #suggestions { margin-top: 10px; padding: 10px; border: 1px solid #ddd; }
        #plot img { max-width: 100%; }
        #download { margin-top: 20px; }
        button, input[type="submit"] { padding: 8px 16px; cursor: pointer; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸ“‚ ä¸Šå‚³å°è©±é€å­—ç¨¿</h1>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required />
        <input type="submit" value="ä¸Šå‚³ä¸¦åˆ†æ" />
    </form>

    <h2>ğŸ“Š è©•åˆ†çµæœ</h2>
    <div id="plot">
        <img id="rating-trend" src="" alt="è©•åˆ†çµæœåœ–å°‡é¡¯ç¤ºæ–¼æ­¤" style="display: none;" />
    </div>

    <h2>ğŸ§© å³æ™‚åˆ†æé€²åº¦</h2>
    <div id="progress"></div>

    <h2>ğŸ’¡ å»ºè­°</h2>
    <div id="suggestions"></div>

    <h2>ğŸ“¥ ä¸‹è¼‰çµæœ</h2>
    <div id="download">
        <a id="download-link" href="" download style="display: none;">ä¸‹è¼‰åˆ†æçµæœ (CSV)</a>
    </div>

    <script>
        const socket = io();
        const form = document.getElementById('upload-form');
        const progress = document.getElementById('progress');
        const suggestions = document.getElementById('suggestions');
        const ratingTrend = document.getElementById('rating-trend');
        const downloadLink = document.getElementById('download-link');

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            progress.innerHTML = 'â³ æ­£åœ¨ä¸Šå‚³æª”æ¡ˆ...';
            const formData = new FormData(form);
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
                progress.innerHTML = 'ğŸŸ¢ æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼Œé–‹å§‹åˆ†æä¸­...';
                suggestions.innerHTML = '';
                ratingTrend.style.display = 'none';
                downloadLink.style.display = 'none';
            } catch (error) {
                progress.innerHTML = `<p class="error">âŒ ä¸Šå‚³å¤±æ•—ï¼š${error.message}</p>`;
            }
        });

        socket.on('update', function (data) {
            progress.innerHTML += `<p>${data.message}</p>`;
        });

        socket.on('plot_generated', function (data) {
            ratingTrend.src = data.plot_url + '?t=' + new Date().getTime();
            ratingTrend.style.display = 'block';
        });

        socket.on('suggestions', function (data) {
            suggestions.innerHTML = `<pre>${data.suggestions}</pre>`;
        });

        socket.on('result_ready', function (data) {
            downloadLink.href = data.result_url;
            downloadLink.style.display = 'block';
        });

        socket.on('error', function (data) {
            progress.innerHTML += `<p class="error">âŒ ${data.message}</p>`;
        });
    </script>
</body>
</html>